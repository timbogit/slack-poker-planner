!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=25)}([function(e,t){e.exports=require("@opentelemetry/api")},function(e,t){e.exports=require("shortid")},function(e,t){e.exports=require("countly-sdk-nodejs")},function(e,t){e.exports=require("@slack/web-api")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("@opentelemetry/tracing")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("lodash/map")},function(e,t){e.exports=require("lodash/find")},function(e,t){e.exports=require("@opentelemetry/exporter-jaeger")},function(e,t){e.exports=require("pino")},function(e,t){e.exports=require("sqlite3")},function(e,t){e.exports=require("sqlite")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("express-handlebars")},function(e,t){e.exports=require("async_hooks")},function(e,t){e.exports=require("lodash/isString")},function(e,t){e.exports=require("lodash/pickBy")},function(e,t){e.exports=require("lodash/chunk")},function(e,t){e.exports=require("lodash/groupBy")},function(e,t){e.exports=require("lodash/isEmpty")},function(e,t){e.exports=require("lodash/uniq")},function(e,t){e.exports=require("pretty-ms")},function(e,t){e.exports=require("dotenv")},function(e,t,n){"use strict";n.r(t);var r=n(6),s=n(10),o=n(11);var i=n.n(o)()({formatters:{level:(e,t)=>({level:e}),bindings:e=>({})}}),a=n(12),c=n(13),l=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};let d;function u(){return d}var p=n(14),m=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};let v;function h(){return v}var f=n(2),_=n.n(f),g=n(5),y=n(7),I=n(15),S=n(3),A=n(16),b=n(0);const P=new A.AsyncLocalStorage;function E(e={}){return(t,n,r)=>{const s=r.value,o=e.name||n;return r.value=function(...e){const t=b.trace.getTracer("default"),n=P.getStore(),r={};n&&(r.parent=n.span);const i=t.startSpan(o,r);try{const t=P.run({span:i},()=>s.apply(this,e));return"object"==typeof t&&t.then&&t.catch?t.then(e=>(i.end(),e)).catch(e=>{throw i.addEvent("error",{event:"error",message:e.message,stack:e.stack,"error.kind":e.name}),i.setStatus({code:b.CanonicalCode.UNKNOWN,message:e.message}),i.end(),e}):(i.end(),t)}catch(e){throw i.addEvent("error",{event:"error",message:e.message,stack:e.stack,"error.kind":e.name}),i.setStatus({code:b.CanonicalCode.UNKNOWN,message:e.message}),i.end(),e}},r}}function N(){const e=P.getStore();return null==e?void 0:e.span}var x,T=function(e,t,n,r){var s,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(t,n,i):s(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},k=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};!function(e){e.PARTICIPANTS="participants",e.POINTS="points",e.PROTECTED="protected",e.AVERAGE="average"}(x||(x={}));let O=(()=>{class e{static findById(e){return k(this,void 0,void 0,(function*(){const t=N();null==t||t.setAttribute("id",e);return u().get("SELECT * FROM team WHERE id = ?",e)}))}static create({id:e,name:t,access_token:n,scope:r,user_id:s}){return k(this,void 0,void 0,(function*(){const o=N();null==o||o.setAttributes({id:e,name:t,scope:r,user_id:s});const i=u();yield i.run("INSERT INTO\n          team (id, name, access_token, scope, user_id)\n        VALUES\n          ($id, $name, $access_token, $scope, $user_id)",{$id:e,$name:t,$access_token:n,$scope:r,$user_id:s})}))}static update({id:e,name:t,access_token:n,scope:r,user_id:s}){return k(this,void 0,void 0,(function*(){const o=N();null==o||o.setAttributes({id:e,name:t,scope:r,user_id:s});const i=u();yield i.run("UPDATE\n        team\n      SET\n        name = $name,\n        access_token = $access_token,\n        scope = $scope,\n        user_id = $user_id\n      WHERE\n        id = $id",{$id:e,$name:t,$access_token:n,$scope:r,$user_id:s})}))}static upsert({id:t,name:n,access_token:r,scope:s,user_id:o}){return k(this,void 0,void 0,(function*(){const i=N();null==i||i.setAttributes({id:t,name:n,scope:s,user_id:o});return(yield e.findById(t))?yield e.update({id:t,name:n,access_token:r,scope:s,user_id:o}):yield e.create({id:t,name:n,access_token:r,scope:s,user_id:o}),e.findById(t)}))}static fetchSettings(e,t){return k(this,void 0,void 0,(function*(){const n=N();null==n||n.setAttributes({teamId:e,channelId:t});const r=u(),s=yield r.all("SELECT\n        setting_key,\n        setting_value\n      FROM\n        channel_settings\n      WHERE\n        team_id = $teamId AND\n        channel_id = $channelId;",{$teamId:e,$channelId:t}),o={};return s.forEach(e=>{o[e.setting_key]=e.setting_value}),o}))}static upsertSettings(t,n,r){return k(this,void 0,void 0,(function*(){const s=Object.keys(r).map(s=>e.upsertSetting(t,n,s,r[s]));yield Promise.all(s)}))}static upsertSetting(e,t,n,r){return k(this,void 0,void 0,(function*(){const s=N();null==s||s.setAttributes({teamId:e,channelId:t,key:n,value:r});const o=u();yield o.run("INSERT INTO\n        channel_settings (team_id, channel_id, setting_key, setting_value)\n      VALUES (\n        $teamId,\n        $channelId,\n        $settingKey,\n        $settingValue\n      )\n      ON CONFLICT(team_id, channel_id, setting_key)\n      DO UPDATE SET setting_value = $settingValue;",{$teamId:e,$channelId:t,$settingKey:n,$settingValue:r})}))}}return T([E({name:"team.findById"})],e,"findById",null),T([E({name:"team.create"})],e,"create",null),T([E({name:"team.update"})],e,"update",null),T([E({name:"team.upsert"})],e,"upsert",null),T([E()],e,"fetchSettings",null),T([E()],e,"upsertSettings",null),T([E()],e,"upsertSetting",null),e})();var C=n(1),w=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};function L(e){return w(this,void 0,void 0,(function*(){try{return[void 0,yield e]}catch(e){return[e,void 0]}}))}var $=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};class j{static handle(e,t){return $(this,void 0,void 0,(function*(){if(e.query.error)return i.error({msg:"Could not oauth",err:e.query.error}),t.status(500).send(e.query.error);if(e.query.code){const n=new S.WebClient,[r,s]=yield L(n.oauth.v2.access({client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET,code:e.query.code}));if(r){const e=Object(C.generate)();return i.error({msg:"Could not oauth, slack api call failed",errorId:e,err:r}),t.status(500).send(`Internal server error, please try again (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}const[o,a]=yield L(O.upsert({id:s.team.id,name:s.team.name,access_token:s.access_token,scope:s.scope,user_id:s.authed_user.id}));if(o){const e=Object(C.generate)();i.error({msg:"Could not oauth, sqlite upsert failed",errorId:e,err:o}),t.status(500).send(`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}return process.env.COUNTLY_APP_KEY&&_.a.add_event({key:"added_to_team",count:1,segmentation:{}}),i.info({msg:"Added to team",team:a}),t.render("oauth-success",{layout:!1,data:{SLACK_APP_ID:process.env.SLACK_APP_ID,TEAM_NAME:a.name}})}const n=Object(C.generate)();return i.error({msg:"Could not oauth, unknown error",errorId:n,query:e.query}),t.status(500).send(`Unknown error (error code: ${n})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}))}}var U=n(17),R=n.n(U),K=n(4),M=n(18),D=n.n(M),Y=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};function q(e){return`${process.env.REDIS_NAMESPACE}:session:${e}`}let V={};const B={};function G(e){V[e.id]=e,process.env.USE_REDIS&&(B[e.id]&&clearTimeout(B[e.id]),B[e.id]=setTimeout(()=>function(e){return Y(this,void 0,void 0,(function*(){if(!process.env.USE_REDIS)return;delete B[e];const t=V[e];if(!t)return;const n=t.expiresAt-Date.now();if(n<=0)return;const r=h(),s=Object(K.promisify)(r.set.bind(r));try{yield s(q(t.id),JSON.stringify(t),"PX",n)}catch(e){i.error({msg:"Could not persist session",err:e,session:t,remainingTTL:n})}}))}(e.id),1e3))}function F(e){return Y(this,void 0,void 0,(function*(){if(delete V[e],process.env.USE_REDIS){const t=h(),n=Object(K.promisify)(t.del.bind(t));yield n(q(e))}}))}setInterval(()=>{const e=Date.now(),t=Object.keys(V).length;V=D()(V,t=>t.expiresAt-e>0);const n=t-Object.keys(V).length;n>0&&i.info({msg:"Cleaned up expired sessions",count:n})},6e4);var J=n(19),H=n.n(J),W=n(8),Q=n.n(W),z=n(20),X=n.n(z),Z=function(e,t,n,r){var s,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(t,n,i):s(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},ee=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};const te=["0","0.5","1","2","3","5","8","13","20","40","100","∞","?"];var ne;!function(e){e.NO_PARTICIPANTS="no_participants",e.TITLE_REQUIRED="title_required",e.INVALID_POINTS="invalid_points",e.SESSION_NOT_ACTIVE="session_not_active",e.ONLY_PARTICIPANTS_CAN_VOTE="only_participants_can_vote"}(ne||(ne={}));let re=(()=>{class e{static postMessage(e,t){return ee(this,void 0,void 0,(function*(){const n=new S.WebClient(t.access_token),r=Q()(e.participants.sort(),e=>`<@${e}>: awaiting`).join("\n");return n.chat.postMessage({channel:e.channelId,text:`Title: *${e.title}*\n\nVotes:\n${r}`,attachments:se(e)})}))}static openModal({triggerId:e,team:t,channelId:n,title:r,participants:s,points:o,isProtected:i,calculateAverage:a}){return ee(this,void 0,void 0,(function*(){const c=new S.WebClient(t.access_token),l={text:{type:"plain_text",text:"Protected (prevent others to cancel or reveal this session)",emoji:!0},value:"protected"},d={text:{type:"plain_text",text:"Calculate the average (only numeric points will be used)",emoji:!0},value:"average"};let u=void 0;i&&(u=u||[],u.push(l)),a&&(u=u||[],u.push(d)),yield c.views.open({trigger_id:e,view:{callback_id:"newSessionModal:submit",private_metadata:JSON.stringify({channelId:n}),type:"modal",title:{type:"plain_text",text:"Poker Planner",emoji:!0},submit:{type:"plain_text",text:"Start New Session",emoji:!0},close:{type:"plain_text",text:"Cancel",emoji:!0},blocks:[{type:"input",block_id:"title",element:{type:"plain_text_input",placeholder:{type:"plain_text",text:"Write a topic for this voting session",emoji:!0},initial_value:r||""},label:{type:"plain_text",text:"Title",emoji:!0}},{type:"input",block_id:"participants",element:{type:"multi_users_select",placeholder:{type:"plain_text",text:"Add users",emoji:!0},initial_users:s},label:{type:"plain_text",text:"Participants",emoji:!0}},{type:"input",block_id:"points",element:{type:"plain_text_input",placeholder:{type:"plain_text",text:"Change poker points",emoji:!0},initial_value:o.join(" ")||te.join(" ")},hint:{type:"plain_text",text:"Enter points separated by space",emoji:!0},label:{type:"plain_text",text:"Points",emoji:!0}},{type:"input",block_id:"other",optional:!0,element:{type:"checkboxes",options:[l,d],initial_options:u},label:{type:"plain_text",text:"Other",emoji:!0}},{type:"section",text:{type:"mrkdwn",text:"> :bulb: These options will be *remembered* the next time you create a session *on this channel*."}}]}})}))}static revealAndUpdateMessage(t,n,r){return ee(this,void 0,void 0,(function*(){t.state="revealed",yield e.updateMessage(t,n,r),yield F(t.id)}))}static cancelAndUpdateMessage(t,n,r){return ee(this,void 0,void 0,(function*(){t.state="cancelled",yield e.updateMessage(t,n,r),yield F(t.id)}))}static vote(t,n,r,s){return ee(this,void 0,void 0,(function*(){if("active"!=t.state)throw new Error(ne.SESSION_NOT_ACTIVE);if(-1==t.participants.indexOf(r))throw new Error(ne.ONLY_PARTICIPANTS_CAN_VOTE);if(t.votes[r]=s,t.state=Object.keys(t.votes).length==t.participants.length?"revealed":"active","revealed"==t.state)return yield e.updateMessage(t,n),yield F(t.id),void i.info({msg:"Auto revealing votes",sessionId:t.id,team:{id:n.id,name:n.name}});yield e.updateMessage(t,n),G(t)}))}static updateMessage(t,n,r){return ee(this,void 0,void 0,(function*(){const s=new S.WebClient(n.access_token);if("revealed"==t.state){const n=X()(t.participants,e=>t.votes[e]||"not-voted"),o=Object.keys(n).sort((e,n)=>t.points.indexOf(e)-t.points.indexOf(n)).map(e=>{const t=n[e],r=1==t.length?"1 person":t.length+" people",s=t.sort().map(e=>`<@${e}>`).join(", ");return"not-voted"==e?`${r} *did not vote* (${s})`:`${r} voted *${e}* (${s})`}).join("\n");let i="";if(t.average){i=e.getAverage(t.votes)?"\nAverage: "+e.getAverage(t.votes):""}yield s.chat.update({ts:t.rawPostMessageResponse.ts,channel:t.rawPostMessageResponse.channel,text:r?`Title: *${t.title}* (revealed by <@${r}>)\n\nResult:\n${o}${i}`:`Title: *${t.title}*\n\nResult:\n${o}${i}`,attachments:[]})}else if("cancelled"==t.state)yield s.chat.update({ts:t.rawPostMessageResponse.ts,channel:t.rawPostMessageResponse.channel,text:r?`Title: *${t.title}* (cancelled by <@${r}>)`:`Title: *${t.title}* (cancelled)`,attachments:[]});else{const e=Q()(t.participants.sort(),e=>t.votes.hasOwnProperty(e)?`<@${e}>: :white_check_mark:`:`<@${e}>: awaiting`).join("\n");yield s.chat.update({ts:t.rawPostMessageResponse.ts,channel:t.rawPostMessageResponse.channel,text:`Title: *${t.title}*\n\nVotes:\n${e}`,attachments:se(t)})}}))}static getAverage(t){const n=Object.values(t).filter(e.isNumeric).map(parseFloat);return!(n.length<1)&&(n.reduce((e,t)=>e+t)/n.length).toFixed(1)}static isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}static stripMentions(e){return e.replace(/<@(.*?)>/g,"").replace(/<!(.*?)>/g,"").replace(/\s\s+/g," ").trim()}}return Z([E()],e,"postMessage",null),Z([E()],e,"openModal",null),Z([E()],e,"revealAndUpdateMessage",null),Z([E()],e,"cancelAndUpdateMessage",null),Z([E()],e,"vote",null),Z([E()],e,"updateMessage",null),e})();function se(e){return[...H()(e.points,5).map(t=>({text:"",fallback:"You are unable to vote",callback_id:"vote:"+e.id,color:"#3AA3E3",attachment_type:"default",actions:t.map(e=>({name:"point",text:e,type:"button",value:e}))})),{text:"Actions",fallback:"You are unable to send action",callback_id:"action:"+e.id,color:"#3AA3E3",attachment_type:"default",actions:[{name:"action",text:"Reveal",type:"button",value:"reveal",style:"danger"},{name:"action",text:"Cancel",type:"button",value:"cancel",style:"danger"}]}]}var oe=function(e,t,n,r){var s,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(t,n,i):s(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},ie=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};let ae=(()=>{class e{static handle(t,n){return ie(this,void 0,void 0,(function*(){const r=t.body;if(r.token!=process.env.SLACK_VERIFICATION_TOKEN)return i.error({msg:"Could not created session, slack verification token is invalid",cmd:r}),n.json({text:"Invalid slack verification token, please get in touch with the maintainer",response_type:"ephemeral",replace_original:!1});if(!R()(r.text)){const e=Object(C.generate)();return i.error({msg:"Could not created session, command.text not string",errorId:e,cmd:r}),n.json({text:`Unexpected command usage (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}switch(r.text.trim().split(" ")[0]){case"help":return e.help(n);case"config":return yield e.configure(r,n);default:return yield e.openNewSessionModal(r,n)}}))}static openNewSessionModal(e,t){return ie(this,void 0,void 0,(function*(){const n=N();if(null==n||n.setAttributes({teamId:e.team_id,teamDomain:e.team_domain,channelId:e.channel_id,channelName:e.channel_name,userId:e.user_id,userName:e.user_name,text:e.text}),"directmessage"==e.channel_name)return t.json({text:"Poker planning cannot be started in direct messages",response_type:"ephemeral",replace_original:!1});const[r,s]=yield L(O.findById(e.team_id));if(r){const s=Object(C.generate)();return i.error({msg:"Could not created session, could not get the team from db",errorId:s,err:r,cmd:e}),null==n||n.setAttribute("error.id",s),null==n||n.setStatus({code:b.CanonicalCode.INTERNAL,message:r.message}),t.json({text:`Internal server error, please try again later (error code: ${s})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!s)return i.info({msg:"Could not created session, team could not be found",cmd:e}),null==n||n.setStatus({code:b.CanonicalCode.NOT_FOUND,message:"Team not found"}),t.json({text:`Your Slack team (${e.team_domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});if("identify,commands,channels:read,groups:read,users:read,chat:write:bot"==s.scope)return i.info({msg:"Migration message",team:{id:s.id,name:s.name},user:{id:e.user_id,name:e.user_name}}),null==n||n.addEvent("show_migration_message"),t.json({text:`Poker Planner has migrated to <https://slackhq.com/introducing-a-dramatically-upgraded-slack-app-toolkit|Slack's new app toolkit> which adds granular permissions for better security. We now depend on bot permissions instead of user permissions. So that you can explicitly manage which channels/conversations Poker Planner can access. However, this requires a couple of changes:\n\n• In order to obtain new bot permissions and drop user ones, *you need to reinstall Poker Planner* to your workspace on <${process.env.APP_INSTALL_LINK}>\n• Before using \`/pp\` command, *Poker Planner app must be added to that channel/conversation*. You can simply add or invite it by just mentioning the app like \`@poker_planner\`. You can also do that from channel/converstion details menu.`,response_type:"ephemeral",replace_original:!1});try{const[r,o]=yield L(O.fetchSettings(s.id,e.channel_id));r&&(null==n||n.addEvent("settings_fetch_error",{error:r.message}));const i={[x.PARTICIPANTS]:[],[x.POINTS]:te,[x.PROTECTED]:!1,[x.AVERAGE]:!1};(null==o?void 0:o[x.PARTICIPANTS])&&(i[x.PARTICIPANTS]=o[x.PARTICIPANTS].split(" ")),s.custom_points&&(i[x.POINTS]=s.custom_points.split(" ")),(null==o?void 0:o[x.POINTS])&&(i[x.POINTS]=o[x.POINTS].split(" ")),(null==o?void 0:o[x.PROTECTED])&&(i[x.PROTECTED]=JSON.parse(o[x.PROTECTED])),(null==o?void 0:o[x.AVERAGE])&&(i[x.AVERAGE]=JSON.parse(o[x.AVERAGE])),yield re.openModal({triggerId:e.trigger_id,team:s,channelId:e.channel_id,title:re.stripMentions(e.text).trim(),participants:i[x.PARTICIPANTS],points:i[x.POINTS],isProtected:i[x.PROTECTED],calculateAverage:i[x.AVERAGE]}),t.send(),process.env.COUNTLY_APP_KEY&&_.a.add_event({key:"new_session_modal_opened",count:1,segmentation:{}})}catch(r){const s=Object(C.generate)();return i.error({msg:"Could not open modal",errorId:s,err:r,cmd:e}),null==n||n.setAttribute("error.id",s),null==n||n.setStatus({code:b.CanonicalCode.INTERNAL,message:r.message}),t.json({text:`Could not open modal (error code: ${s})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}))}static configure(e,t){return ie(this,void 0,void 0,(function*(){return t.json({text:"This command is deprecated. The session settings (points, participants, ...) are now persisted automatically for each channel/conversation.",response_type:"ephemeral",replace_original:!1})}))}static help(e){return e.json({text:"",response_type:"ephemeral",replace_original:!1,attachments:[{color:"#3AA3E3",text:"`/pp`\nOpens a dialog to start a new poker planning session."},{color:"#3AA3E3",text:"`/pp some topic text`\nOpens the same dialog, however title input is automatically filled with the value you provided."}]})}}return oe([E()],e,"openNewSessionModal",null),e})();var ce=n(21),le=n.n(ce),de=n(22),ue=n.n(de),pe=n(9),me=n.n(pe),ve=function(e,t,n,r){var s,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(t,n,i):s(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},he=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};let fe=(()=>{class e{static handle(t,n){return he(this,void 0,void 0,(function*(){let r;try{r=JSON.parse(t.body.payload)}catch(e){const r=Object(C.generate)();return i.error({msg:"Could not parse action payload",errorId:r,body:t.body}),n.json({text:`Unexpected slack action payload (error code: ${r})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(r.token!=process.env.SLACK_VERIFICATION_TOKEN)return i.error({msg:"Could not process action, invalid verification token",payload:r}),n.json({text:"Invalid slack verification token, please get in touch with the maintainer",response_type:"ephemeral",replace_original:!1});switch(r.type){case"interactive_message":return void(yield e.interactiveMessage({payload:r,res:n}));case"view_submission":return void(yield e.viewSubmission({payload:r,res:n}));default:{const e=Object(C.generate)();return i.error({msg:"Unexpected interactive-message action callbackId",errorId:e,payload:r}),n.json({text:`Unexpected payload type (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static interactiveMessage({payload:t,res:n}){return he(this,void 0,void 0,(function*(){const r=N();null==r||r.setAttributes({callbackId:t.callback_id,teamId:t.team.id,teamDomain:t.team.domain,userId:t.user.id,userName:t.user.name,channelId:t.channel.id,channelName:t.channel.name});const s=t.callback_id.split(":");if(2!=s.length){const e=Object(C.generate)();return i.error({msg:"Unexpected interactive message callback id",errorId:e,payload:t}),null==r||r.setAttribute("error.id",e),null==r||r.setStatus({code:b.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected callback_id"}),n.json({text:`Unexpected interactive message callback id (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}const[o,a]=s;null==r||r.setAttributes({action:o,sessionId:a});const c=V[a];if(!c)return null==r||r.setStatus({code:b.CanonicalCode.NOT_FOUND,message:"Session not found"}),n.json({text:"Ooops, could not find the session, it may be expired or cancelled",response_type:"ephemeral",replace_original:!1});const[l,d]=yield L(O.findById(t.team.id));if(l){const e=Object(C.generate)();return i.error({msg:"Could not get team",errorId:e,err:l,payload:t}),null==r||r.setAttribute("error.id",e),null==r||r.setStatus({code:b.CanonicalCode.INTERNAL,message:l.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!d)return null==r||r.setStatus({code:b.CanonicalCode.NOT_FOUND,message:"Team not found"}),n.json({text:`Your Slack team (${t.team.domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});switch(o){case"action":{const s=t.actions[0].value;if(null==r||r.setAttributes({sessionAction:s}),"reveal"==s)yield e.revealSession({payload:t,team:d,session:c,res:n});else if("cancel"==s)yield e.cancelSession({payload:t,team:d,session:c,res:n});else{const e=Object(C.generate)();i.error({msg:"Unexpected action button clicked",errorId:e,sessionAction:s,payload:t}),null==r||r.setAttribute("error.id",e),null==r||r.setStatus({code:b.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected session action"}),n.json({text:`Unexpected action button (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return}case"vote":return void(yield e.vote({payload:t,team:d,session:c,res:n}));default:{const e=Object(C.generate)();return i.error({msg:"Unexpected action",errorId:e,action:o,payload:t}),null==r||r.setAttribute("error.id",e),null==r||r.setStatus({code:b.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected action"}),n.json({text:`Unexpected action (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static viewSubmission({payload:t,res:n}){return he(this,void 0,void 0,(function*(){const r=N();null==r||r.setAttributes({teamId:t.team.id,teamDomain:t.team.domain,userId:t.user.id,userName:t.user.name});const[s,o]=yield L(O.findById(t.team.id));if(s){const e=Object(C.generate)();return i.error({msg:"Could not create session, could not get the team from db",errorId:e,err:s,payload:t}),null==r||r.setAttribute("error.id",e),null==r||r.setStatus({code:b.CanonicalCode.INTERNAL,message:s.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!o)return i.info({msg:"Could not create session, team could not be found",payload:t}),null==r||r.setStatus({code:b.CanonicalCode.NOT_FOUND,message:"Team not found"}),n.json({text:`Your Slack team (${t.team.domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});const a=t.view.callback_id;switch(null==r||r.setAttributes({callbackId:a}),a){case"newSessionModal:submit":return e.createSession({payload:t,team:o,res:n});default:{const e=Object(C.generate)();return i.error({msg:"Unexpected view-submission action callbackId",errorId:e,callbackId:a,payload:t}),null==r||r.setAttribute("error.id",e),null==r||r.setStatus({code:b.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected callback_id"}),n.json({text:`Unexpected view-submission callback id (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static createSession({payload:e,team:t,res:n}){return he(this,void 0,void 0,(function*(){const r=N();try{null==r||r.setAttributes({rawPrivateMetadata:e.view.private_metadata});const s=JSON.parse(e.view.private_metadata),o=e.view.state.values.title,a=o[Object.keys(o)[0]].value;if(null==r||r.setAttributes({title:a}),!a||0==a.trim().length)throw new Error(ne.TITLE_REQUIRED);const c=e.view.state.values.participants,l=c[Object.keys(c)[0]].selected_users;if(null==r||r.setAttributes({participants:l.join(" ")}),0==l.length)throw new Error(ne.NO_PARTICIPANTS);const d=e.view.state.values.points,u=d[Object.keys(d)[0]].value||"";let p=ue()(u.match(/\S+/g))||[];if(null==r||r.setAttributes({points:u}),1==p.length&&"reset"==p[0]&&(p=te),p.length<2||p.length>25)throw new Error(ne.INVALID_POINTS);const m=e.view.state.values.other,v=m?m[Object.keys(m)[0]].selected_options:[],h=!!me()(v,e=>"protected"==e.value),f=!!me()(v,e=>"average"==e.value);null==r||r.setAttributes({isProtected:""+h}),null==r||r.setAttributes({calculateAverage:""+f});const g={id:Object(C.generate)(),expiresAt:Date.now()+Number(process.env.SESSION_TTL),title:a,points:p,votes:{},state:"active",channelId:s.channelId,userId:e.user.id,participants:l,rawPostMessageResponse:void 0,protected:h,average:f};null==r||r.setAttributes({sessionId:g.id,channelId:s.channelId,userId:e.user.id,userName:e.user.name}),i.info({msg:"Creating a new session",team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name},channelId:s.channelId,sessionId:g.id});const y=yield re.postMessage(g,t);g.rawPostMessageResponse=y,G(g),n.send();const[I]=yield L(O.upsertSettings(t.id,g.channelId,{[x.PARTICIPANTS]:g.participants.join(" "),[x.POINTS]:g.points.join(" "),[x.PROTECTED]:JSON.stringify(g.protected),[x.AVERAGE]:JSON.stringify(g.average)}));I&&(null==r||r.addEvent("upsert_settings_error",{message:I.message}),i.error({msg:"Could not upsert settings after creating new session",session:g,err:I})),process.env.COUNTLY_APP_KEY&&_.a.add_event({key:"topic_created",count:1,segmentation:{participants:g.participants.length}})}catch(t){const s=Object(C.generate)();let o=!0,a="error",c=`Internal server error, please try again later (error code: ${s})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,l={};const d=t.data&&t.data.error;return d&&(null==r||r.setAttributes({slackErrorCode:d}),c=`Unexpected Slack API Error: "*${d}*" (error code: ${s})\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}>`),"not_in_channel"==d?(o=!1,c='Poker Planner app is not added to this channel. Please try again after adding it. You can simply add the app just by mentioning it, like "*@poker_planner*".'):"channel_not_found"==d?(o=!1,c='Oops, we couldn\'t find this channel. Are you sure that Poker Planner app is added to this channel/conversation? You can simply add the app by mentioning it, like "*@poker_planner*". However this may not work in Group DMs, you need to explicitly add it as a member from conversation details menu. Please try again after adding it.'):"token_revoked"==d?(a="info",c=`Poker Planner's access has been revoked for this workspace. In order to use it, you need to install the app again on <${process.env.APP_INSTALL_LINK}>`):"method_not_supported_for_channel_type"==d?(a="info",c="Poker Planner cannot be used in this type of conversations."):"missing_scope"==d?"mpim:read"==t.data.needed?(a="info",c=`Poker Planner now supports Group DMs! However it requires additional permissions that we didn't obtained previously. You need to visit <${process.env.APP_INSTALL_LINK}> and reinstall the app to enable this feature.`):"usergroups:read"==t.data.needed&&(a="info",c=`Poker Planner now supports @usergroup mentions! However it requires additional permissions that we didn't obtained previously. You need to visit <${process.env.APP_INSTALL_LINK}> and reinstall the app to enable this feature.`):t.message==ne.NO_PARTICIPANTS?(o=!1,c="You must add at least 1 person.",l={participants:c}):t.message==ne.TITLE_REQUIRED?(o=!1,c="Title is required",l={title:c}):t.message==ne.INVALID_POINTS&&(o=!1,c="You must provide at least 2 poker points, the maximum is 25.",l={points:c}),o&&i[a]({msg:"Could not create session",errorId:s,err:t,payload:e}),null==r||r.setAttributes({"error.id":s,userErrorMessage:c}),null==r||r.setStatus({code:b.CanonicalCode.UNKNOWN,message:t.message}),le()(l)?n.json({response_action:"push",view:{type:"modal",title:{type:"plain_text",text:"Poker Planner",emoji:!0},close:{type:"plain_text",text:"Close",emoji:!0},blocks:[{type:"section",text:{type:"mrkdwn",text:":x: "+c}}]}}):n.json({response_action:"errors",errors:l})}}))}static vote({payload:e,team:t,session:n,res:r}){var s,o;return he(this,void 0,void 0,(function*(){const a=N(),c=e.actions[0].value;null==a||a.setAttributes({point:c}),i.info({msg:"Voting",point:c,sessionId:n.id,team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name}});const[l]=yield L(re.vote(n,t,e.user.id,c));if(l)switch(l.message){case ne.SESSION_NOT_ACTIVE:return r.json({text:"You cannot vote revealed or cancelled session",response_type:"ephemeral",replace_original:!1});case ne.ONLY_PARTICIPANTS_CAN_VOTE:return r.json({text:"You are not a participant of that session",response_type:"ephemeral",replace_original:!1});default:{const t=Object(C.generate)();let n=`Internal server error, please try again later (error code: ${t})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`;const c=null===(o=null===(s=l)||void 0===s?void 0:s.data)||void 0===o?void 0:o.error;return c&&(null==a||a.setAttributes({slackErrorCode:c}),n=`Unexpected Slack API Error: "*${c}*", please try again later (error code: ${t})\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}>`),"channel_not_found"==c&&(n=`Unexpected Slack API Error: "*${c}*". Are you using Poker Planner on a shared channel? Shared channels are not supported due to Slack API limitations.\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}> with this error code: ${t}`),i.error({msg:"Could not vote",errorId:t,err:l,payload:e}),null==a||a.setAttributes({"error.id":t}),null==a||a.setStatus({code:b.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected vote error"}),r.json({text:n,response_type:"ephemeral",replace_original:!1})}}return process.env.COUNTLY_APP_KEY&&_.a.add_event({key:"topic_voted",count:1,segmentation:{points:e.actions[0].value}}),r.send()}))}static revealSession({payload:e,team:t,session:n,res:r}){var s,o;return he(this,void 0,void 0,(function*(){const a=N();if(null==a||a.setAttributes({sessionProtected:n.protected,sessionCreatorId:n.userId}),n.protected&&n.userId!=e.user.id)return r.json({text:"This session is protected, only the creator can reveal it.",response_type:"ephemeral",replace_original:!1});i.info({msg:"Revealing votes",sessionId:n.id,team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name}});const[c]=yield L(re.revealAndUpdateMessage(n,t,e.user.id));if(c){const t=Object(C.generate)();let n=`Internal server error, please try again later (error code: ${t})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`;const l=null===(o=null===(s=c)||void 0===s?void 0:s.data)||void 0===o?void 0:o.error;return l&&(null==a||a.setAttributes({slackErrorCode:l}),n=`Unexpected Slack API Error: "*${l}*", please try again later (error code: ${t})\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}>`),"channel_not_found"==l&&(n=`Unexpected Slack API Error: "*${l}*". Are you using Poker Planner on a shared channel? Shared channels are not supported due to Slack API limitations.\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}> with this error code: ${t}`),i.error({msg:"Could not reveal session",errorId:t,err:c,payload:e}),null==a||a.setAttributes({"error.id":t}),null==a||a.setStatus({code:b.CanonicalCode.INTERNAL,message:"Unexpected error while reveal session & update message"}),r.json({text:n,response_type:"ephemeral",replace_original:!1})}return process.env.COUNTLY_APP_KEY&&_.a.add_event({key:"topic_revealed",count:1,segmentation:{}}),r.send()}))}static cancelSession({payload:e,team:t,session:n,res:r}){var s,o;return he(this,void 0,void 0,(function*(){const a=N();if(null==a||a.setAttributes({sessionProtected:n.protected,sessionCreatorId:n.userId}),n.protected&&n.userId!=e.user.id)return r.json({text:"This session is protected, only the creator can cancel it.",response_type:"ephemeral",replace_original:!1});i.info({msg:"Cancelling session",sessionId:n.id,team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name}});const[c]=yield L(re.cancelAndUpdateMessage(n,t,e.user.id));if(c){const t=Object(C.generate)();let n=`Internal server error, please try again later (error code: ${t})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`;const l=null===(o=null===(s=c)||void 0===s?void 0:s.data)||void 0===o?void 0:o.error;return l&&(null==a||a.setAttributes({slackErrorCode:l}),n=`Unexpected Slack API Error: "*${l}*", please try again later (error code: ${t})\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}>`),"channel_not_found"==l&&(n=`Unexpected Slack API Error: "*${l}*". Are you using Poker Planner on a shared channel? Shared channels are not supported due to Slack API limitations.\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}> with this error code: ${t}`),i.error({msg:"Could not cancel session",errorId:t,err:c,payload:e}),null==a||a.setAttributes({"error.id":t}),null==a||a.setStatus({code:b.CanonicalCode.INTERNAL,message:"Unexpected error while cancel session & update message"}),r.json({text:n,response_type:"ephemeral",replace_original:!1})}return process.env.COUNTLY_APP_KEY&&_.a.add_event({key:"topic_cancelled",count:1,segmentation:{}}),r.send()}))}}return ve([E()],e,"interactiveMessage",null),ve([E()],e,"viewSubmission",null),ve([E()],e,"createSession",null),ve([E()],e,"vote",null),ve([E()],e,"revealSession",null),ve([E()],e,"cancelSession",null),e})();var _e=n(23),ge=n.n(_e),ye=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((r=r.apply(e,t||[])).next())}))};n(24).config(),function(){ye(this,void 0,void 0,(function*(){const e=new r.BasicTracerProvider;if(e.register(),!process.env.REPORT_TRACES)return;const t=new s.JaegerExporter({serviceName:"pp",tags:[],host:process.env.JAEGER_HOST,port:parseInt(process.env.JAEGER_PORT,10),logger:{debug:()=>{},info:()=>{},warn:i.warn.bind(i),error:i.error.bind(i)}});e.addSpanProcessor(new r.BatchSpanProcessor(t)),i.info({msg:"Trace reporter started",jaegerAgent:{host:process.env.JAEGER_HOST,port:process.env.JAEGER_PORT}})}))}(),function(){return ye(this,void 0,void 0,(function*(){yield function(){return l(this,void 0,void 0,(function*(){return d?(i.warn({msg:"Trying to init sqlite multiple times!"}),d):(i.info({msg:"Opening sqlite..."}),d=yield Object(c.open)({filename:process.env.DB_FILE,driver:a.Database}),i.info({msg:"Migrating sqlite..."}),yield d.migrate(),d)}))}(),process.env.USE_REDIS&&(yield function(){return m(this,void 0,void 0,(function*(){return v?(i.warn({msg:"Trying to init redis multiple times!"}),v):(i.info({msg:"Creating redis client..."}),v=p.createClient(process.env.REDIS_URL),yield new Promise((e,t)=>{v.once("ready",e),v.once("error",t)}),v.on("error",e=>{i.error({msg:"Unexpected redis error",err:e})}),v)}))}(),yield function(){return Y(this,void 0,void 0,(function*(){if(!process.env.USE_REDIS)return;const e=h(),t=Object(K.promisify)(e.scan.bind(e)),n=[];let r="0";do{const e=yield t(r,"MATCH",process.env.REDIS_NAMESPACE+":session:*");r=e[0],n.push(...e[1])}while("0"!==r);if(n.length>0){const t=Object(K.promisify)(e.mget.bind(e));(yield t(n)).forEach(e=>{if(e)try{const t=JSON.parse(e);V[t.id]=t}catch(e){}})}i.info({msg:"Sessions restored from redis",count:Object.keys(V).length})}))}()),yield function(){return ye(this,void 0,void 0,(function*(){const e=g();return e.engine("html",I({extname:".html"})),e.set("view engine","html"),e.set("views","src/views"),e.use(y.urlencoded({extended:!1})),e.use(y.json()),e.use(process.env.BASE_PATH,g.static("src/public")),function(e){const t=g.Router(),n=ge()(Number(process.env.SESSION_TTL),{verbose:!0});t.get("/",(e,t,r)=>{t.render("index",{layout:!1,data:{SLACK_CLIENT_ID:process.env.SLACK_CLIENT_ID,SLACK_SCOPE:process.env.SLACK_SCOPE,SLACK_APP_ID:process.env.SLACK_APP_ID,COUNTLY_URL:process.env.COUNTLY_URL,COUNTLY_APP_KEY:process.env.COUNTLY_APP_KEY,HUMAN_READABLE_SESSION_TTL:n}})}),t.get("/privacy",(e,t,n)=>{t.render("privacy",{layout:!1,data:{SLACK_APP_ID:process.env.SLACK_APP_ID,COUNTLY_URL:process.env.COUNTLY_URL,COUNTLY_APP_KEY:process.env.COUNTLY_APP_KEY}})}),t.get("/oauth",j.handle),t.post("/slack/pp-command",ae.handle),t.post("/slack/pp-slash-command",ae.handle),t.post("/slack/action-endpoint",fe.handle),t.post("/slack/interactivity",fe.handle),t.get("/slack/direct-install",(e,t,n)=>{const r=`https://slack.com/oauth/v2/authorize?client_id=${process.env.SLACK_CLIENT_ID}&scope=${process.env.SLACK_SCOPE}`;t.status(302).redirect(r)}),e.use(""+process.env.BASE_PATH,t)}(e),new Promise((t,n)=>{e.listen(process.env.PORT,e=>{if(e)return n(e);i.info({msg:"Server running",port:process.env.PORT}),t()})})}))}(),process.env.COUNTLY_APP_KEY&&process.env.COUNTLY_URL&&(i.info({msg:"Initing countly",url:process.env.COUNTLY_URL,appKey:process.env.COUNTLY_APP_KEY}),_.a.init({app_key:process.env.COUNTLY_APP_KEY,url:process.env.COUNTLY_URL})),i.info({msg:"Boot successful!"})}))}().catch(e=>{i.error({msg:"Could not boot",err:e}),process.exit(1)})}]);
//# sourceMappingURL=app.js.map